<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>A Machine Learning Climate Model based on a Deep Convolutional Variational AutoEncoder &#8212; An ML Climate Model based on a DCVAE</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/sphinxdoc.css?v=87629129" />
    <script src="_static/documentation_options.js?v=8d563738"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Default model" href="ML_default/index.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ML_default/index.html" title="Default model"
             accesskey="N">next</a> |</li>
        <li class="nav-item nav-item-0"><a href="#">DCVAE-Climate</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">A Machine Learning Climate Model based on a Deep Convolutional Variational AutoEncoder</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="a-machine-learning-climate-model-based-on-a-deep-convolutional-variational-autoencoder">
<h1>A Machine Learning Climate Model based on a Deep Convolutional Variational AutoEncoder<a class="headerlink" href="#a-machine-learning-climate-model-based-on-a-deep-convolutional-variational-autoencoder" title="Link to this heading">¶</a></h1>
<p>This is an example of how to build a climate model using Machine Learning (ML). It’s designed to be used as a training tool for those new to ML, but to be powerful enough to be adapted into something of value for science work.</p>
<p>The fundamental objective is to build a model that is useful for climate science - in particular, in this case, to predict and attribute changes in precipitation - but using ML, rather than a traditional physical model. A great virtue of this approach is the ML model is <em>dramatically</em> cheaper than a physical model, both to create and to use.</p>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">¶</a></h2>
<p>Climate Scientists are mostly used to using physical models (<a class="reference external" href="https://www.ipcc-data.org/guidelines/pages/gcm_guide.html">GCMs</a>). It is important to understand that ML models are quite a different thing - don’t think of an ML model as a new variant of GCM.</p>
<ul class="simple">
<li><p>When building a GCM we specify how the model behaves. The aim is to make the model as close to physical reality as possible. The results produced by the model are then an emergent property, and they will be correct if the model is an adequate representation of the real world. So, with a GCM, the focus is on the model itself.</p></li>
<li><p>When building an ML model, we specify what the model learns. The aim is to make the model as good as possible at predicting the data we have given it. The results produced by the model are then a prediction, and they will be correct if the model has learned the patterns in the data. So, with an ML model, the focus is on the data used in training, and the model is an emergent property - ML models do have to correspond to reality, but they don’t have to do so in any way we’d recognize as physics.</p></li>
</ul>
<p>So physical modellers care primarily about the physical correctness of their model, and only secondarily about their validation statistics. ML modellers care primarily about their validation statistics, and the issue of physical correctness does not arise. (Of course this is a simplification - real science is much more complex than this, but it is nonetheless an important distinction.)</p>
<p>A result of this is that GCMs are, in a sense, all trying to do the same thing - they are all trying to represent the same set of physical equations. ML models can be much more diverse - each is trying to predict its training data, and the training data can be anything. So GCMs are generic: one GCM - many applications. ML models are specific: we should expect to train a new model for each new problem. (It is possible to train generic ML models, but this is difficult, expensive, and will be less accurate than training a specific model. The majority of ML models used in climate will be problem-specific)</p>
<p>So the first task is to choose a problem. This model is built to study monthly precipitation - in particular to represent the spatial distribution of precipitation (to what extent can we infer the precipitation in London given the precipitation in Birmingham), and the relationship between precipitation and other variables (how does precipitation relate to 2m-air temperature and mean-sea-level pressure). This is a convenient example problem, but note that the model may well be of interest even if you don’t care about precipitation: The model we are training here is precipitation-specific, but the model code and structure are much more generic - you could take the same model specification, and the same software, and train it on a different dataset, to make an ML model of use for your own work.</p>
</section>
<section id="design-decisions">
<h2>Design Decisions<a class="headerlink" href="#design-decisions" title="Link to this heading">¶</a></h2>
<p>Our aim, with a climate model, is typically to generate an estimate of some future climate state, so the obvious tool is a <a class="reference external" href="https://en.wikipedia.org/wiki/Generative_artificial_intelligence">generative model</a>. That is, a model that will make new, plausible climate states.</p>
<figure class="align-center" id="id2">
<a class="reference internal image-reference" href="_images/Slide1.PNG"><img alt="_images/Slide1.PNG" src="_images/Slide1.PNG" style="width: 95%;" /></a>
<figcaption>
<p><span class="caption-text">Illustration of a generative model outputting a climate state.</span><a class="headerlink" href="#id2" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>So how do we make such a model? A principal virtue of ML, is that there are already several well established ML methods for making generative models, here we will use a <a class="reference external" href="https://en.wikipedia.org/wiki/Autoencoder#Variational_autoencoder_(VAE)">Variational AutoEncoder</a> (VAE). The VAE is a generative model factory - it learns such models from example inputs. The main virtue of the VAE is that it provides a specifically-constrained model state vector, which offers additional ways to control the model output, effectively allowing us to do <a class="reference external" href="http://brohan.org/Proxy_20CR/">data assimilation</a>.</p>
<figure class="align-center" id="id3">
<a class="reference internal image-reference" href="_images/Slide2.PNG"><img alt="_images/Slide2.PNG" src="_images/Slide2.PNG" style="width: 95%;" /></a>
<figcaption>
<p><span class="caption-text">Illustration of a VAE - a factory for making generative models given examples of the desired output.</span><a class="headerlink" href="#id3" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="ML_default/index.html">Detailed specification of the ML model</a></li>
</ul>
</div>
</section>
<section id="training-data">
<h2>Training data<a class="headerlink" href="#training-data" title="Link to this heading">¶</a></h2>
<p>To learn the model, we need good quality training data. We are modelling the relationships between 2m temperature, mean-sea-level-pressure, and precipitation, so we need training data for these three variables. We will get these data from the ERA5 reanalysis.</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="get_data/index.html">How to download the training data</a></li>
</ul>
</div>
<p>That provides the data, in original units (degrees Kelvin, pascals, and mm/s) as a collection of <a class="reference external" href="https://www.unidata.ucar.edu/software/netcdf/">netCDF</a> files. To use the data in an ML model, we need to make several transformations:</p>
<ol class="arabic simple">
<li><p>Regrid to a <a class="reference internal" href="utils/grids.html"><span class="doc">standard grid</span></a> (not strictly necessary if we are only using ERA5 output, but I regrid it anyway to move the longitude range from 0-360 to -180-180 - let’s have the UK in the middle of the map).</p></li>
<li><p>Convert the data from <a class="reference external" href="https://www.unidata.ucar.edu/software/netcdf/">netCDF</a> to an efficient format for ML (I use serialized <a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/Tensor">tf.tensors</a>).</p></li>
<li><p>Normalize the data to be approximately normally distributed on the range 0-1 (I use quantile mapping).</p></li>
</ol>
<figure class="align-center" id="id4">
<a class="reference internal image-reference" href="_images/monthly_precip_1969_03.png"><img alt="_images/monthly_precip_1969_03.png" src="_images/monthly_precip_1969_03.png" style="width: 95%;" /></a>
<figcaption>
<p><span class="caption-text">Precipitation (map and PDF) for March 1969. Raw data above, normalized data below.</span><a class="headerlink" href="#id4" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="normalization/index.html">How to convert and normalize the data</a></li>
</ul>
</div>
</section>
<section id="training-the-model">
<h2>Training the model<a class="headerlink" href="#training-the-model" title="Link to this heading">¶</a></h2>
<p>Once we have the data in the right format, we can train the model. The details are in the <a class="reference internal" href="ML_default/index.html"><span class="doc">ML model specification</span></a>. The key steps are:</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="ML_default/specify.html">Specify the details of the model</a></li>
<li class="toctree-l1"><a class="reference internal" href="ML_default/make_dataset.html">Assemble the normalized data into training and test datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="ML_default/training.html">Train the model</a></li>
</ul>
</div>
<figure class="align-center" id="id5">
<a class="reference internal image-reference" href="_images/training.webp"><img alt="_images/training.webp" src="_images/training.webp" style="width: 95%;" /></a>
<figcaption>
<p><span class="caption-text">Model training progress plot. (<a class="reference internal" href="ML_default/plot_history.html"><span class="doc">More details</span></a>)</span><a class="headerlink" href="#id5" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>We want to see the loss function get down close to zero, for both the training data (pale lines), and for the test data (darker lines). If the individual variable values are below one, then the model has skill - it’s better than climatology.</p>
</section>
<section id="validating-the-trained-model">
<h2>Validating the trained model<a class="headerlink" href="#validating-the-trained-model" title="Link to this heading">¶</a></h2>
<p>Once we have trained the model, we need to validate it. This is a crucial step - the model is only useful if it can predict data it has not seen before. We already know if the model has skill - we can see that from the training loss, but it’s worth looking in more detail:</p>
<figure class="align-center" id="id6">
<a class="reference internal image-reference" href="_images/comparison.webp"><img alt="_images/comparison.webp" src="_images/comparison.webp" style="width: 95%;" /></a>
<figcaption>
<p><span class="caption-text">Model validation for a single month: Target on the left, model output in the middle, scatter comparison on the right. (<a class="reference internal" href="ML_default/validation.html"><span class="doc">More details</span></a>)</span><a class="headerlink" href="#id6" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>And as well as looking at individual months, we can look at the model’s performance over the whole dataset:</p>
<figure class="align-center" id="id7">
<a class="reference internal image-reference" href="_images/multi.webp"><img alt="_images/multi.webp" src="_images/multi.webp" style="width: 95%;" /></a>
<figcaption>
<p><span class="caption-text">Model validation time-series: Global-mean values for each month in the test dataset - target in black, model output in red. (<a class="reference internal" href="ML_default/validate_multi.html"><span class="doc">More details</span></a>)</span><a class="headerlink" href="#id7" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>Clearly the VAE works usefully - good accuracy for T2m and MSLP, and reasonable accuracy for precipitation. The model is not perfect, but it is a useful tool for understanding the relationships between these variables.</p>
</section>
<section id="using-as-a-generative-model">
<h2>Using as a generative model<a class="headerlink" href="#using-as-a-generative-model" title="Link to this heading">¶</a></h2>
<p>So the DCVAE works well - it can convert fields of T2m and MSLP into an embedding, and then convert that embedding back into fields of T2m, MSLP, and Precip. But we want a generative model - to make new fields of T2m, MSLP, and Precip. To test this we just take the decoder half of the model, and generate the output fields from a random embedding.</p>
<p>To do this we use the <a class="reference internal" href="ML_default/assimilation.html"><span class="doc">assimilation scripts</span></a> but don’t assimilate anything - just generate the fields from a random embedding.</p>
<figure class="align-center" id="id8">
<a class="reference internal image-reference" href="_images/assimilated_free.webp"><img alt="_images/assimilated_free.webp" src="_images/assimilated_free.webp" style="width: 95%;" /></a>
<figcaption>
<p><span class="caption-text">Left-hand column - a sample field from the test dataset. Centre column - a field generated from a random embedding. (Note that these columns should not be the same, but the centre column should look like the same sort of thing as the left-hand column). (<span class="xref std std-doc">More details</span>)</span><a class="headerlink" href="#id8" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>It’s hard to say exactly how well this works - the model generated fields are not the same as the test dataset fields, but they are similar.</p>
<p>But the value of the method is not in unconstrained generation, but in constrained generation. We can do the same, but assimilating T2m and MSLP:</p>
<figure class="align-center" id="id9">
<a class="reference internal image-reference" href="_images/assimilated_T+P.webp"><img alt="_images/assimilated_T%2BP.webp" src="_images/assimilated_T%2BP.webp" style="width: 95%;" /></a>
<figcaption>
<p><span class="caption-text">Left-hand column - a sample field from the test dataset. Centre column - a field generated from an embedding chosen to match the T2m and MSLP. (Precip is calculated by the model). (<a class="reference internal" href="ML_default/assimilation.html"><span class="doc">More details</span></a>)</span><a class="headerlink" href="#id9" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>And if we make the time-series diagnostic the same way, we can see the point of the model:</p>
<figure class="align-center" id="id10">
<a class="reference internal image-reference" href="_images/assimilate_multi_T+P.webp"><img alt="_images/assimilate_multi_T%2BP.webp" src="_images/assimilate_multi_T%2BP.webp" style="width: 95%;" /></a>
<figcaption>
<p><span class="caption-text">Global-mean values for each month in the test dataset - ERA5 data in black, model output in red. Here T2m and MSLP have been assimilated, Precip is calculated by the model. (<a class="reference internal" href="ML_default/assimilate_multi.html"><span class="doc">More details</span></a>)</span><a class="headerlink" href="#id10" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>We can not compare <cite>observed</cite> (ERA5) and modelled precipitation, where the modelled precipitation is calculated from observed T2m and MSLP. We can see a notable divergence between the ERA5 and modelled precipitation before about 1980 - this demonstrates the biases in the ERA5 precipitation product.</p>
<p>And we can go on to do an attribution study: Does the trend in precip have a common origin with the trend in T2m? We can test this by only assimilating MSLP - don’t force the T2m trend - and seeing what the calculated Precip does.</p>
<figure class="align-center" id="id11">
<a class="reference internal image-reference" href="_images/assimilate_multi_P_only.webp"><img alt="_images/assimilate_multi_P_only.webp" src="_images/assimilate_multi_P_only.webp" style="width: 95%;" /></a>
<figcaption>
<p><span class="caption-text">Global-mean values for each month in the test dataset - ERA5 data in black, model output in red. MSLP has been assimilated, T2m and Precip are calculated by the model. (<a class="reference internal" href="ML_default/assimilate_multi.html"><span class="doc">More details</span></a>)</span><a class="headerlink" href="#id11" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>The model is now answering the question ‘What would the global Precip trend have looked like if there were no temperature trend?’ And the answer is clear - the Precip trend is driven by the T2m trend - or at least by a common factor (the CO2 increase).</p>
</section>
<section id="conclusions">
<h2>Conclusions<a class="headerlink" href="#conclusions" title="Link to this heading">¶</a></h2>
<p>If we want to understand, predict, and attribute climate change, we don’t need a GCM. We can use ML (and specifically the DCVAE) to build an alternative model, and then use the ML model to answer the questions we have.</p>
</section>
<section id="next-steps">
<h2>Next steps<a class="headerlink" href="#next-steps" title="Link to this heading">¶</a></h2>
<p>This model is trained on monthly T2m, MSLP and Precip. But we could use the same model design on other variables, or at other time-scales. It’s just a matter of getting the data, normalizing it, and training the model. What else can we investigate the same way?</p>
<p>The model is pretty good, but it could be better. Can we improve the model design, or find better hyperparameters?</p>
<p>Go on - <a class="reference internal" href="how_to.html"><span class="doc">try it yourself</span></a>.</p>
</section>
<section id="appendices">
<h2>Appendices<a class="headerlink" href="#appendices" title="Link to this heading">¶</a></h2>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="utils/index.html">Utility functions for plotting and regridding</a></li>
</ul>
</div>
</section>
<section id="small-print">
<h2>Small print<a class="headerlink" href="#small-print" title="Link to this heading">¶</a></h2>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="how_to.html">How to reproduce or extend this work</a></li>
<li class="toctree-l1"><a class="reference internal" href="credits.html">Authors and acknowledgements</a></li>
</ul>
</div>
<p>This document is crown copyright (2024). It is published under the terms of the <a class="reference external" href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/2/">Open Government Licence</a>. Source code included is published under the terms of the <a class="reference external" href="https://opensource.org/licenses/BSD-2-Clause">BSD licence</a>.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="#">
              <img class="logo" src="_static/DCVAE_Climate.webp" alt="Logo"/>
            </a></p>
<h3><a href="#">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="ML_default/index.html">Detailed specification of the ML model</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="get_data/index.html">How to download the training data</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="normalization/index.html">How to convert and normalize the data</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="ML_default/specify.html">Specify the details of the model</a></li>
<li class="toctree-l1"><a class="reference internal" href="ML_default/make_dataset.html">Assemble the normalized data into training and test datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="ML_default/training.html">Train the model</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="utils/index.html">Utility functions for plotting and regridding</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="how_to.html">How to reproduce or extend this work</a></li>
<li class="toctree-l1"><a class="reference internal" href="credits.html">Authors and acknowledgements</a></li>
</ul>
<h3><a href="https://github.com/philip-brohan/DCVAE_Climate">Get a copy</a></h3>

<ul>
    <li><a href="https://github.com/philip-brohan/DCVAE_Climate" rel="nofollow">Github repository</a></li>
</ul>

<h3>Found a bug, or have a suggestion?</h3>

Please <a href="https://github.com/philip-brohan/DCVAE_Climate/issues/new">raise an issue</a>.
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ML_default/index.html" title="Default model"
             >next</a> |</li>
        <li class="nav-item nav-item-0"><a href="#">DCVAE-Climate</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">A Machine Learning Climate Model based on a Deep Convolutional Variational AutoEncoder</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    </div>
  </body>
</html>